# Cloud Build 설정 파일 예시
# 이 파일을 NestJS 레포지토리 루트에 cloudbuild.yaml로 복사하세요

# Service Account를 사용할 때는 로깅 옵션이 필요합니다
options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Node.js 의존성 설치 및 빌드
  - name: 'node:20-alpine'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        npm ci
        npm run build

  # Docker 이미지 빌드
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/umodeler-api:$SHORT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/umodeler-api:latest'
      - '-f'
      - 'Dockerfile'
      - '.'

  # Artifact Registry에 이미지 푸시
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/umodeler-api:$SHORT_SHA'

  # Cloud Run에 배포
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/umodeler-api:$SHORT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'

# Substitution 변수는 Terraform에서 자동으로 설정됩니다:
# _REGION: 리전 (예: us-central1)
# _PROJECT_ID: GCP 프로젝트 ID
# _REPO_NAME: Artifact Registry 리포지토리 ID
# _SERVICE_NAME: Cloud Run 서비스 이름

# 중요 사항:
# 1. Dockerfile이 프로젝트 루트에 있어야 합니다
# 2. Dockerfile 예시는 DEPLOYMENT.md를 참조하세요
# 3. 빌드 실패 시 Cloud Build 로그를 확인하세요:
#    gcloud builds list --limit=5
#    gcloud builds log BUILD_ID

